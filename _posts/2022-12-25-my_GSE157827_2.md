---
layout: mypost
title: 使用我的GSE157827数据进行初步分析-2
category: other
subcategory: other-other
---

2026.1.15-2026.1.31研究进展

<!-- more -->

### 计算family-level计数矩阵

```r
library(Seurat)
library(tidyverse)
library(Matrix)
res_dir <- "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_res"
seu <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\GSE157827_celltype.rds")
seu <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\GSE157827_astro.rds")
seu <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\GSE157827_astro_sub.rds")
```

```r
herv_loc <- GetAssayData(seu, assay = "HERV", layer = "counts")
feat <- rownames(herv_loc)
if(feat[1] == "--no-feature"){
  feat[1] <- "noFeature"
}
fam <- ifelse(grepl("-", feat), sub("-.*$", "", feat), feat)
fam <- factor(fam)
G <- Matrix::sparse.model.matrix(~ 0 + fam)
colnames(G) <- levels(fam)
herv_fam <- Matrix::t(G) %*% herv_loc
seu[["HERV_family"]] <- CreateAssayObject(counts = herv_fam)
all(Matrix::colSums(herv_loc) == Matrix::colSums(herv_fam))
# 标准化
DefaultAssay(seu) <- "HERV_family"
rna_counts  <- GetAssayData(seu, assay = "RNA",  slot = "counts")
herv_counts <- GetAssayData(seu, assay = "HERV_family", slot = "counts")
lib_rna <- Matrix::colSums(rna_counts)
herv_norm <- t(t(herv_counts) / lib_rna) * 10000
herv_norm@x <- log1p(herv_norm@x)
seu <- SetAssayData(seu, assay = "HERV_family", slot = "data", new.data = herv_norm)
DefaultAssay(seu) <- "RNA"
# 保存数据
saveRDS(
  seu, 
  file = "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\GSE157827_celltype.rds", 
  compress = "xz"
)
```

合并后的家族：

```
> herv_fam@Dimnames[[1]]
 [1] "ERV316A3"   "ERVL"       "ERVLB4"     "ERVLE"      "HARLEQUIN"  "HERV3"      "HERV30"     "HERV4"     
 [9] "HERV9"      "HERVE"      "HERVEA"     "HERVFC1"    "HERVFH19"   "HERVFH21"   "HERVFRD"    "HERVH"     
[17] "HERVH48"    "HERVI"      "HERVIP10F"  "HERVIP10FH" "HERVK11"    "HERVK11D"   "HERVK14C"   "HERVKC4"   
[25] "HERVL"      "HERVL18"    "HERVL32"    "HERVL40"    "HERVL66"    "HERVL74"    "HERVP71A"   "HERVS71"   
[33] "HERVW"      "HML1"       "HML2"       "HML3"       "HML4"       "HML5"       "HML6"       "HUERSP1"   
[41] "HUERSP2"    "HUERSP3"    "HUERSP3B"   "LTR19"      "LTR23"      "LTR25"      "LTR46"      "LTR57"     
[49] "MER101"     "MER34B"     "MER4"       "MER41"      "MER4B"      "MER61"      "noFeature"  "PABLA"     
[57] "PABLB"      "PRIMA4"     "PRIMA41"    "PRIMAX" 
```

- HMLx：HERV-K的亚家族，其中HML2是研究最深的一类
- MERx：ERV的LTR（具体来说是ERV1超家族），不过有些MER也可能包括DNA转座子等
- LTRx：某个ERV家族的LTR子家族名
- HARLEQUIN：ERV的internal part，两侧由特定LTR包夹
- HUERSPx：在一套HERV全基因组分类工作里被当作一个HERV类群（有些古老的分类？）
- PRIMAx：Repbase/RepeatMasker的ERV1类实体名（多与灵长类相关）
- PABLx：ERV-P相关、源自ERV的envelope/残片，既可指重复序列家族也可指衍生基因

### 差异表达分析

**所有细胞、六大细胞类型层面比较AD和NC**

```r
assay_herv <- "HERV_family"
group_col_name <- "group"
sample_col_name <- "orig.ident"
celltype_col_name <- "celltype"
min_cells_per_sample <- 20  # 每个样本至少多少个细胞
md <- seu@meta.data
levels_to_run <- c("ALL", sort(unique(as.character(md[[celltype_col_name]]))))
out <- vector("list", length(levels_to_run))
names(out) <- levels_to_run
# 伪bulk聚合计数矩阵
pseudobulk_counts <- function(seu, cells_use, herv_assay = assay_herv, group_col = group_col_name, sample_col = sample_col_name) {
  md <- seu@meta.data[cells_use, , drop = FALSE]
  samp <- factor(md[[sample_col]])
  M <- Matrix::sparse.model.matrix(~ 0 + samp)
  colnames(M) <- levels(samp)
  X <- GetAssayData(seu, assay = herv_assay, layer = "counts")[, cells_use, drop = FALSE]
  pb <- X %*% M
  grp_by_samp <- tapply(md[[group_col]], md[[sample_col]], function(x) unique(x))
  grp_raw <- sapply(grp_by_samp, function(x) x[[1]])
  grp_chr <- ifelse(as.character(grp_raw) == "2", "AD", "NC")
  sample_md <- data.frame(
    sample  = names(grp_by_samp),
    group   = factor(grp_chr, levels = c("NC", "AD")),
    n_cells = as.integer(table(md[[sample_col]])[names(grp_by_samp)]),
    libsize = as.numeric(Matrix::colSums(pb)),
    row.names = names(grp_by_samp)
  )
  list(counts = pb, sample_md = sample_md)
}
# 伪bulk差异表达分析（默认模型）
pb_edger_nb <- function(pb_counts, sample_md) {
  y <- edgeR::DGEList(counts = pb_counts, samples = sample_md)
  cat("features before filterByExpr:", nrow(y), "\n")
  keep <- edgeR::filterByExpr(y, group = sample_md$group)
  y <- y[keep, , keep.lib.sizes = FALSE]
  cat("features after  filterByExpr:", nrow(y), "\n")
  y <- edgeR::calcNormFactors(y)
  design <- model.matrix(~ group, data = sample_md)
  y <- edgeR::estimateDisp(y, design)
  fit <- edgeR::glmQLFit(y, design, robust = TRUE)
  qlf <- edgeR::glmQLFTest(fit, coef = "groupAD")
  out <- edgeR::topTags(qlf, n = Inf)$table
  out$feature <- rownames(out)
  out[order(out$FDR), c("feature", "logFC", "PValue", "FDR", "logCPM")]
}
# 伪bulk差异表达分析（泊松分布）
pb_glm_poisson <- function(pb_counts, sample_md, quasi = FALSE) {
  fam <- if (quasi) quasipoisson() else poisson()
  grp <- sample_md$group
  off <- log(sample_md$libsize + 1)
  res <- lapply(rownames(pb_counts), function(g) {
    y <- as.numeric(pb_counts[g, ])
    fit <- glm(y ~ grp, family = fam, offset = off)
    co  <- summary(fit)$coefficients
    pcol <- intersect(c("Pr(>|z|)", "Pr(>|t|)"), colnames(co))
    pcol <- pcol[1]
    data.frame(
      feature = g,
      logFC   = unname(co["grpAD", "Estimate"] / log(2)),
      PValue  = unname(co["grpAD", pcol]),
      stringsAsFactors = FALSE
    )
  })
  out <- do.call(rbind, res)
  out$FDR <- p.adjust(out$PValue, method = "BH")
  out[order(out$FDR), ]
}
# 普通单细胞差异分析
sc_findmarkers <- function(seu, cells_use, co_vars = sample_col_name, herv_assay = assay_herv, group_col = group_col_name, sample_col = sample_col_name, test_use = "MAST") {
  sub <- subset(seu, cells = cells_use)
  DefaultAssay(sub) <- herv_assay
  Idents(sub) <- sub[[group_col, drop = TRUE]]
  if(length(co_vars)){
    FindMarkers(
      sub,
      ident.1 = "AD", ident.2 = "NC",
      test.use = test_use,
      latent.vars = sample_col
    )
  }
  else{
    FindMarkers(
      sub,
      ident.1 = "AD", ident.2 = "NC",
      test.use = test_use,
    )
  }
}
# 进行分析
for (lv in levels_to_run) {
  print(paste("running level:", lv))
  cells_use <- if (lv == "ALL") {
    colnames(seu)
  } else {
    rownames(md)[as.character(md[[celltype_col_name]]) == lv]
  }
  pb <- pseudobulk_counts(seu, cells_use)
  keep_samp <- pb$sample_md$n_cells >= min_cells_per_sample
  pb_counts <- pb$counts[, keep_samp, drop = FALSE]
  pb_md     <- pb$sample_md[keep_samp, , drop = FALSE]
  layer_res <- list()
  print("- running pseudo-bulk")
  print("  - running pb_edgeR")
  layer_res$pb_edgeR_NB <- pb_edger_nb(pb_counts, pb_md)
  print("  - running pb_Poisson")
  layer_res$pb_Poisson <- pb_glm_poisson(pb_counts, pb_md, quasi = FALSE)
  print("  - running pb_quasiPoisson")
  layer_res$pb_quasiPoisson <- pb_glm_poisson(pb_counts, pb_md, quasi = TRUE)
  print("- running FindMarkers")
  print("  - running MAST")
  layer_res$sc_MAST <- sc_findmarkers(seu, cells_use, test_use = "MAST")
  print("  - running wilcox")
  layer_res$sc_wilcox <- sc_findmarkers(seu, cells_use, c(), test_use = "wilcox")
  out[[lv]] <- layer_res
}
save(out, file = "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\0116_1.RData")
# 整合结果
methods_5 <- c(
  "pb_edgeR_NB",
  "pb_Poisson",
  "pb_quasiPoisson",
  "sc_MAST",
  "sc_wilcox"
)
.pick_pcol <- function(df) {  # 识别p值
  cand <- c("PValue", "p_val", "pvalue", "p.value", "Pr(>|z|)", "Pr(>|t|)")
  cand <- cand[cand %in% colnames(df)]
  cand[1]
}
.topN_by_p <- function(x, n = 20) {  # 取前n列保存成df
  df <- as.data.frame(x)
  if (!("feature" %in% colnames(df))) df$feature <- rownames(df)
  df <- df[, c("feature", setdiff(colnames(df), "feature")), drop = FALSE]
  pcol <- .pick_pcol(df)
  if (is.null(pcol)) return(utils::head(df, n))
  df <- df[order(df[[pcol]], na.last = TRUE), , drop = FALSE]
  utils::head(df, n)
}
out_split <- setNames(vector("list", length(out)), names(out))
for (lv in names(out)) {
  lv_res <- out[[lv]]
  lv_names <- names(lv_res)
  lv_pack <- setNames(vector("list", length(methods_5)), methods_5)
  for (m in methods_5) {
    if (m %in% lv_names) {
      lv_pack[[m]] <- .topN_by_p(lv_res[[m]], n = 20)
    } else {
      lv_pack[[m]] <- data.frame()
    }
  }
  out_split[[lv]] <- lv_pack
}
for (lv in names(out_split)) {
  assign(paste0("out_", make.names(lv)), out_split[[lv]])
}
```

在edgeR过滤特征时，除Endo/Mic这种细胞数本来就少的细胞类型，基本都保留了50个左右的特征

logFC为正值：AD表达更高
- 全部细胞的5种方法结果：
  - edgeR
  
  ![my_GSE157827_2_1](/upload/md-image/other/my_GSE157827_2_1.png){:width="450px" height="450px"}

  - Poisson
  
  ![my_GSE157827_2_2](/upload/md-image/other/my_GSE157827_2_2.png){:width="450px" height="450px"}

  - quasiPoisson
  
  ![my_GSE157827_2_3](/upload/md-image/other/my_GSE157827_2_3.png){:width="400px" height="400px"}

  - wilcox
  
  ![my_GSE157827_2_5](/upload/md-image/other/my_GSE157827_2_5.png){:width="500px" height="500px"}

  - MAST
  
  ![my_GSE157827_2_4](/upload/md-image/other/my_GSE157827_2_4.png){:width="500px" height="500px"}


- Astro的5种方法结果：
  - edgeR
  
  ![my_GSE157827_2_6](/upload/md-image/other/my_GSE157827_2_6.png){:width="450px" height="450px"}

  - Poisson
  
  ![my_GSE157827_2_7](/upload/md-image/other/my_GSE157827_2_7.png){:width="450px" height="450px"}

  - quasiPoisson
  
  ![my_GSE157827_2_8](/upload/md-image/other/my_GSE157827_2_8.png){:width="400px" height="400px"}

  - wilcox
  
  ![my_GSE157827_2_9](/upload/md-image/other/my_GSE157827_2_9.png){:width="500px" height="500px"}

  - MAST
  
  ![my_GSE157827_2_10](/upload/md-image/other/my_GSE157827_2_10.png){:width="500px" height="500px"}

综上，在较大层面上，即使把hERV位点聚合到family水平，信号仍偏弱，并且个体差异/hERV的稀疏性/细胞组成差异会把这个差异冲淡

---

看一下上面结果中比较显著的hERV家族在主要细胞类型中的平均表达分布（差异来自“表达强度”还是“阳性细胞比例/亚群富集”）

```r
astro_sub_col <- "subpop"
# 候选hERV家族
cand <- c(
  "HERVK14C","HML1","HERVKC4","HERVL74","HML4","HML3","HML2",
  "MER101","MER41","MER4","HUERSP1","HARLEQUIN",
  "HERVFH21","HERVEA","HERV3","HERVH48","HERV30","HERVL32"
)
features <- intersect(cand, rownames(seu[[assay_herv]]))
# 计算AD/NC的detect_rate/mean
summarize_family <- function(seu, features, cells_use, herv_assay = assay_herv, group_col = group_col_name, level_name = "ALL") {
  md <- seu@meta.data[cells_use, , drop = FALSE]
  grp <- as.character(md[[group_col]])
  Xc <- GetAssayData(seu, assay = herv_assay, layer = "counts")[features, cells_use, drop = FALSE]
  Xd <- GetAssayData(seu, assay = herv_assay, layer = "data")[features, cells_use, drop = FALSE]
  out <- lapply(c("NC","AD"), function(g) {
    idx <- which(grp == g)
    Xc_g <- Xc[, idx, drop = FALSE]
    Xd_g <- Xd[, idx, drop = FALSE]
    data.frame(
      level       = level_name,
      group       = g,
      n_cells     = length(idx),
      feature     = features,
      detect_rate = Matrix::rowMeans(Xc_g > 0),
      mean_logexpr= Matrix::rowMeans(Xd_g),
      mean_counts = Matrix::rowMeans(Xc_g),
      row.names = NULL,
      stringsAsFactors = FALSE
    )
  })
  do.call(rbind, out)
}
# 所有细胞+6个细胞大类+astro聚类
res_all <- summarize_family(seu, features, colnames(seu), level_name = "ALL")
ct <- as.character(seu@meta.data[[celltype_col_name]])
celltypes <- sort(unique(ct))
res_ct <- do.call(rbind, lapply(celltypes, function(k) {
  cells_use <- rownames(seu@meta.data)[ct == k]
  summarize_family(seu, features, cells_use, level_name = k)
}))
sublab <- as.character(scRNA_astro@meta.data[, astro_sub_col])
sublabs <- sort(unique(sublab))
astro_cells <- rownames(scRNA_astro@meta.data)[T]
res_astro_sub <- do.call(rbind, lapply(sublabs, function(s) {
  cells_use <- astro_cells[sublab == s]
  summarize_family(scRNA_astro, features, cells_use, level_name = paste0("Astro_", s))
}))
summary_tab <- rbind(res_all, res_ct, res_astro_sub)
summary_tab$delta_detect   <- NA_real_
summary_tab$delta_logexpr  <- NA_real_
# 给每个level-feature计算AD-NC的差
key <- paste(summary_tab$level, summary_tab$feature, sep = "||")
for (k in unique(key)) {
  i <- which(key == k)
  if (length(i) != 2) next
  if (!all(sort(summary_tab$group[i]) == c("AD","NC"))) next
  ad <- i[summary_tab$group[i] == "AD"]
  nc <- i[summary_tab$group[i] == "NC"]
  summary_tab$delta_detect[i]  <- summary_tab$detect_rate[ad]  - summary_tab$detect_rate[nc]
  summary_tab$delta_logexpr[i] <- summary_tab$mean_logexpr[ad] - summary_tab$mean_logexpr[nc]
}
save(summary_tab, file = "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\0116_2.RData")
all_res <- summary_tab %>% 
  filter(level=="ALL", group=="AD") %>% 
  arrange(-abs(delta_logexpr))
View(all_res)
astro_res <- summary_tab %>% 
  filter(level=="Astro", group=="AD") %>% 
  arrange(-abs(delta_logexpr))
View(astro_res)
astro_sub_res <- summary_tab %>% 
  filter(level=="Astro_Up", group=="AD") %>% 
  arrange(-abs(delta_logexpr))
View(astro_sub_res)
# 所有细胞的hERV家族表达可视化（点大小=percent expressed，颜色=avg exp）
DotPlot(
  seu, features = features,
  assay = assay_herv,
  group.by = "tissue",
  split.by = group_col_name
) + RotatedAxis()
# 6个细胞大类
DotPlot(
  seu, features = features,
  assay = assay_herv,
  group.by = celltype_col_name,
  split.by = group_col_name
) + RotatedAxis()
# Astro子群
DotPlot(
  scRNA_astro, features = features,
  assay = assay_herv,
  group.by = astro_sub_col,
  split.by = group_col_name
) + RotatedAxis()
```

- 所有细胞的AD-NC对比

  ![my_GSE157827_2_11](/upload/md-image/other/my_GSE157827_2_11.png){:width="600px" height="600px"}

  ![my_GSE157827_2_12](/upload/md-image/other/my_GSE157827_2_12.png){:width="600px" height="600px"}

- astro的hERV表达计量和6个细胞大类的hERV表达图谱

  ![my_GSE157827_2_13](/upload/md-image/other/my_GSE157827_2_13.png){:width="600px" height="600px"}

  ![my_GSE157827_2_14](/upload/md-image/other/my_GSE157827_2_14.png){:width="600px" height="600px"}

- Astro细胞按up/down分组，AD_up的hERV表达计量和分组后的hERV表达图谱

  ![my_GSE157827_2_15](/upload/md-image/other/my_GSE157827_2_15.png){:width="600px" height="600px"}

  ![my_GSE157827_2_16](/upload/md-image/other/my_GSE157827_2_16.png){:width="600px" height="600px"}

再试一试新思路：把AD_Up中的AD细胞与整个astro亚群的NC细胞进行差异分析

```r
assay_use    <- "HERV_family"
celltype_col <- "celltype"
subpop_col   <- "subpop"
group_col    <- "group"
sample_col   <- "orig.ident"
md <- scRNA_astro@meta.data
cells_case <- rownames(md)[md[[celltype_col]] == "Astro" &
                           md[[subpop_col]]   == "Up" &
                           md[[group_col]]    == "AD"]
cells_ctrl <- rownames(md)[md[[celltype_col]] == "Astro" &
                           md[[group_col]]    == "NC"]
cells_use <- union(cells_case, cells_ctrl)
sub <- subset(scRNA_astro, cells = cells_use)
sub$comp <- ifelse(colnames(sub) %in% cells_case, "AD_up_AD", "Astro_NC")
DefaultAssay(sub) <- assay_use
Idents(sub) <- "comp"
# 普通单细胞
de_mast <- FindMarkers(
  sub,
  ident.1 = "AD_up_AD",
  ident.2 = "Astro_NC",
  test.use = "MAST",
  latent.vars = sample_col,
  logfc.threshold = 0,
  min.pct = 0.01
)
de_wilcox <- FindMarkers(
  sub,
  ident.1 = "AD_up_AD",
  ident.2 = "Astro_NC",
  logfc.threshold = 0,
  min.pct = 0.01
)
View(de_mast[order(de_mast$p_val_adj), ])
View(de_wilcox[order(de_mast$p_val_adj), ])
# edgeR
X <- GetAssayData(seu, assay = assay_use, slot = "counts")[, cells_use, drop = FALSE]
samp <- md[cells_use, sample_col]
grp  <- ifelse(cells_use %in% cells_case, "AD_up_AD", "Astro_NC")
M <- sparse.model.matrix(~0 + factor(samp))
colnames(M) <- levels(factor(samp))
pb <- X %*% M
meta_samp <- data.frame(
  sample  = colnames(pb),
  group   = tapply(grp, samp, function(x) unique(x)),
  n_cells = as.integer(table(samp)[colnames(pb)])
)
stopifnot(all(lengths(meta_samp$group) == 1))
meta_samp$group <- factor(unlist(meta_samp$group), levels = c("Astro_NC", "AD_up_AD"))
y <- DGEList(counts = pb, group = meta_samp$group)
keep <- filterByExpr(y, group = meta_samp$group)
y <- y[keep, , keep.lib.sizes = FALSE]
y <- calcNormFactors(y)
design <- model.matrix(~ group, data = meta_samp)
y <- estimateDisp(y, design)
fit <- glmQLFit(y, design)
qlf <- glmQLFTest(fit, coef = "groupAD_up_AD")
de_edger <- topTags(qlf, n = Inf)$table
View(de_edger)
# 保存结果
save(de_mast, de_wilcox, de_edger, file = "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\my_data\\0117_1.RData")
```

![my_GSE157827_2_17](/upload/md-image/other/my_GSE157827_2_17.png){:width="500px" height="500px"}

![my_GSE157827_2_18](/upload/md-image/other/my_GSE157827_2_18.png){:width="500px" height="500px"}

![my_GSE157827_2_19](/upload/md-image/other/my_GSE157827_2_19.png){:width="500px" height="500px"}

可以看到结果确实更显著了一些。综合上述结果，发现有几个HMLx、MERx表达差异还是挺稳健的，由此可以先确定我们研究的主要hERV家族？

### try1

根据讨论时定的方向“有没有哪些细胞类型/亚群的hERV表达有差别”、“根据某些hERV的表达情况来找特殊亚群”，尝试第一个新方向：
- 把几个关键hERV家族统一成一个模块(signature)
- 给每个细胞打分，定义HERV-high/HERV-low（类似于之前AD_up/AD_down的思路？）
- 看它们富集在哪些细胞类型/状态/AD亚群
- 与基因共表达联动

**先做一个简单的尝试**：就使用上面edgeR的结果，加上我自己判定的比较常见的hERV家族
- sig_up（logFC>0，Up组/AD表达更高）：HML5、HML2、HML6、LTR25、LTR19、HERVFH21、HERVFRD、HERVEA、HERV4、HERVIP10F、HERVIP10FH、HERVK11
- sig_down：HML1、HML3、HML4、HERVK14C、HERVH48、HERVE、HERVW、MER101、MER4

```r
sig_up <- c("HML5","HML2","HML6","LTR25","LTR19","HERVFH21","HERVFRD","HERVEA","HERV4","HERVIP10F","HERVIP10FH","HERVK11")
sig_down <- c("HML1","HML3","HML4","HERVK14C","HERVH48","HERVE","HERVW","MER101","MER4")
assay_herv <- "HERV_family"
# 表达量
Xd <- GetAssayData(scRNA_astro, assay = assay_herv, slot = "data")
DefaultAssay(scRNA_astro) <- assay_herv
scRNA_astro$HERVsigUP_expr   <- if (length(sig_up)==0) NA else Matrix::colMeans(Xd[sig_up, , drop=FALSE])
scRNA_astro$HERVsigDOWN_expr <- if (length(sig_down)==0) NA else Matrix::colMeans(Xd[sig_down, , drop=FALSE])
# 检出比例
Xc <- GetAssayData(scRNA_astro, assay = assay_herv, slot = "counts")
scRNA_astro$HERVsigUP_detect <- if (length(sig_up)==0) NA else Matrix::colMeans(Xc[sig_up, , drop=FALSE] > 0)
scRNA_astro$HERVsigDOWN_detect <- if (length(sig_down)==0) NA else Matrix::colMeans(Xc[sig_down, , drop=FALSE] > 0)
VlnPlot(scRNA_astro, features = c("HERVsigDOWN_expr","HERVsigDOWN_detect"), group.by = "subpop", pt.size = 0)
VlnPlot(scRNA_astro, features = c("HERVsigDOWN_expr","HERVsigDOWN_detect"), group.by = "subpop", split.by="group", pt.size = 0)
```

![my_GSE157827_2_20](/upload/md-image/other/my_GSE157827_2_20.png){:width="600px" height="600px"}

![my_GSE157827_2_21](/upload/md-image/other/my_GSE157827_2_21.png){:width="600px" height="600px"}

down基因在down组中表达更高，虽然不是特别明显。因为Up基因的FDR普遍较高（FDR<0.2的基因几乎都是down，所以拿down基因定义HERV-high/low状态：
- 在Astro内用detect分位数切HERV-high/low
- 看它是否富集在Down/Up

```r
x <- scRNA_astro$HERVsigDOWN_detect
# 定义HERV-high/low
q_hi <- quantile(x, 0.8, na.rm = TRUE)
q_lo <- quantile(x, 0.2, na.rm = TRUE)
scRNA_astro$HERVclass_sigDOWN <- ifelse(x >= q_hi, "HERV-high",
                           ifelse(x <= q_lo, "HERV-low", "mid"))
table(scRNA_astro$HERVclass_sigDOWN, useNA="ifany")
# 每个subpop里high/low比例
tab_state <- table(scRNA_astro$HERVclass_sigDOWN, scRNA_astro$subpop)
prop.table(tab_state, 2)
```

```
> prop.table(tab_state, 2)
                   Up      Down No change
  HERV-high 0.2588884 0.6128544 0.3020725
  HERV-low  0.3996731 0.1209830 0.3711555
  mid       0.3414385 0.2661626 0.3267720
> tab_state
              Up Down No change
  HERV-high 1267 1621      3192
  HERV-low  1956  320      3922
  mid       1671  704      3453
```

整体来说符合预期——AD_down中有较多的down基因表达高(HERV-high)的细胞，AD_up中较少，No change介于两者之间，说明"sigDOWN"定义的high和low确实能够对应不同状态。结合我前面画的小提琴图，可以看到在AD-NC的层面，"sigDOWN"差别不大，所以这里的信号主要来自AD_down/up的状态差异，而不是“疾病主效应”（AD的差异基因/差异hERV不稳健很正常，更值得做的是“状态/亚群层面的解释”）

与基因结合分析：
- 在astro内的HERV-high与HERV-low中做基因差异
- 做GO/通路富集
- 看这些基因模块与Up/Down的关系

```r
DefaultAssay(scRNA_astro) <- "HERV_family"
seuA <- subset(scRNA_astro, subset = HERVclass_sigDOWN %in% c("HERV-high","HERV-low"))
DefaultAssay(seuA) <- "RNA"
Idents(seuA) <- "HERVclass_sigDOWN"
de_hervHL_res <- FindMarkers(
  seuA,
  ident.1 = "HERV-high",
  ident.2 = "HERV-low",
  # test.use = "MAST",
  # latent.vars = c("orig.ident"),
) 
de_hervHL <- de_hervHL_res %>%
  rownames_to_column("gene") %>%
  filter(p_val_adj < 0.05, abs(avg_log2FC) >= 0.25) %>% 
  filter(pct.1 >= 0.1 | pct.2 >= 0.1) %>%
  filter(!grepl("^(ENSG|MT-)|(AC|AL|LINC|AP)[0-9]", gene))
up_genes <- (filter(de_hervHL, avg_log2FC > 0))$gene  # HERV-high更高表达
down_genes <- (filter(de_hervHL, avg_log2FC < 0))$gene
```

![my_GSE157827_2_22](/upload/md-image/other/my_GSE157827_2_22.png){:width="500px" height="500px"}

```r
# 背景基因：Astro里检测到过的基因
expr_counts <- GetAssayData(seuA, assay = "RNA", slot = "counts")
bg <- rownames(expr_counts)[Matrix::rowSums(expr_counts > 0) >= 10]
ego_up <- enrichGO(
  gene          = up_genes,
  universe      = bg,
  OrgDb         = org.Hs.eg.db,
  keyType       = "SYMBOL",
  ont           = "BP",
  pAdjustMethod = "BH",
  qvalueCutoff  = 1,
  pvalueCutoff  = 1,
  readable      = TRUE
)
ego_down <- enrichGO(
  gene          = down_genes,
  universe      = bg,
  OrgDb         = org.Hs.eg.db,
  keyType       = "SYMBOL",
  ont           = "BP",
  pAdjustMethod = "BH",
  qvalueCutoff  = 1,
  pvalueCutoff  = 1,
  readable      = TRUE
)
dotplot(ego_up, showCategory = 15) + ggtitle("GO BP: Up in HERV-high")
dotplot(ego_down, showCategory = 15) + ggtitle("GO BP: Up in HERV-low")
```

![my_GSE157827_2_23](/upload/md-image/other/my_GSE157827_2_23.png){:width="600px" height="600px"}

![my_GSE157827_2_24](/upload/md-image/other/my_GSE157827_2_24.png){:width="600px" height="600px"}

```r
Xd <- GetAssayData(seuA, assay="RNA", slot="data")
up_genes2   <- intersect(up_genes, rownames(Xd))
down_genes2 <- intersect(down_genes, rownames(Xd))
seuA$GeneSig_HERVhigh_expr <- Matrix::colMeans(Xd[up_genes2, , drop=FALSE])
seuA$GeneSig_HERVlow_expr  <- Matrix::colMeans(Xd[down_genes2, , drop=FALSE])
# 这些基因在Up/Down/No change上是否有梯度
VlnPlot(seuA,
        features = c("GeneSig_HERVhigh_expr","GeneSig_HERVlow_expr"),
        group.by = "subpop",
        split.by = "group",
        pt.size = 0)
```

![my_GSE157827_2_25](/upload/md-image/other/my_GSE157827_2_25.png){:width="600px" height="600px"}

通过富集结果，可以看出HERV-high与HERV-low的差异基因确实是与神经系统有关（虽然神经系统的GO条目占比并不多，不过联想到之前跟教程走的结果，其实还可以接受）
- `GeneSig_HERVhigh_expr`这个分数在Down组最高（某些ERV/LTR的检出率高），同时一些神经系统相关的基因上调（这套基因程序在Down状态最强）
- 我之后又使用了edgeR做了样本级的差异分析，结果类似

附上GPT对这段的解读：
- 用ERV/hERV的家族signature定义了新的“ERV-activity状态”
- 该状态与astro的Up/Down强相关
- 该状态对应一组基因表达程序（炎症/应激/IFN等）
- AD的作用更多体现在状态比例/调制，而非稳定主效应

**这就是一个简易版的基因共表达？**

之后我又看了HERV-high与HERV-low的nCount/Feature_RNA情况：

![my_GSE157827_2_26](/upload/md-image/other/my_GSE157827_2_26.png){:width="500px" height="500px"}

感觉这个HERV-high/low的划分就有些诡异（受到测序深度/复杂度影响很大）

### try2

能不能在try1的基础上简化一些？
- 不分那么多的细胞类群（HERV-high、HERV-low这种），就使用6个细胞大类，以及Astro和Oligo的子聚类亚群
- 找某个或某几个关键hERV家族，看其在细胞群体中的表达差异
- 这个差异是否能定义某个亚群（根据hERV家族而不是普通基因划分亚群？）
- 这个差异与哪些基因有关（hERV与基因的共表达），是否有“某个基因的表达量与某个hERV家族的表达相关”

首先为了提高分析的针对性，我用GPT分析了差异表达分析的结果（5种方法在所有细胞和astro细胞中 AD-NC的差异）
- 最核心的几个：
  - **HML1 / HML3 / HML4 / HERVK14C**：基本都属于HERV-K谱系，常被拿来讨论潜在转录/蛋白表达与疾病相关性；同时检出率也不算太低
  - **MER101**：MER是ERV/LTR衍生的重复元件家族，可用于说明“ERV/LTR的转录/调控状态变化”
  - **HERVH48**：HERV-H48（可能不属于HERV-H大类，使用的命名体系不同？）
- 可选：
  - **MER41**：提供转录因子结合位点、参与干扰素应答调控网络，可用于说明“AD炎症/免疫环境变化”
  - **HERV-W**：HERV-W家族相关的env（Syncytin-1）也有一些相关研究
  - **HERVEA**：HERV-E家族在不同组织/疾病里经常被讨论（尤其肿瘤方向较多）
  - **HARLEQUIN**：虽然相关研究较少，但在差异分析结果中频繁出现
- 上述hERV家族，好像只有HERVEA是AD上调，其它都是下调

**先画几张“单family分布图”直观看**
```r
assay_herv <- "HERV_family"
assay_rna  <- "RNA"
astro_sub_col <- "sle_reso"
DefaultAssay(seu) <- assay_herv
DefaultAssay(scRNA_astro) <- assay_herv
panel <- c("HML1","HML3","HML4","HERVK14C","MER101","HERVH48",
             "MER41","HERVW","HARLEQUIN","HERVEA")
to_plot <- c("HML1","HERVEA","HERVH48","MER101")
# UMAP上看表达
FeaturePlot(seu, features = to_plot, reduction = "umap", order = TRUE)
# Astro子群里的分布
FeaturePlot(scRNA_astro, features = to_plot, reduction = "umap", order = TRUE)
```

![my_GSE157827_2_27](/upload/md-image/other/my_GSE157827_2_27.png){:width="800px" height="800px"}

![my_GSE157827_2_28](/upload/md-image/other/my_GSE157827_2_28.png){:width="800px" height="800px"}

可以看到，即使把hERV聚合到family级别，总体仍比较稀疏，对于某一家族，并不是大多数细胞都有表达

**计算panel分数：expr_score/detect_score**

```r
# 计算候选hERV家族的分数
Xd <- GetAssayData(seu, assay = assay_herv, slot = "data")[panel, , drop = FALSE]
Xc <- GetAssayData(seu, assay = assay_herv, slot = "counts")[panel, , drop = FALSE]
seu$herv_expr_score <- Matrix::colMeans(Xd)
seu$herv_detect_score <- Matrix::colMeans(Xc > 0)
Xd <- GetAssayData(scRNA_astro, assay = assay_herv, slot = "data")[panel, , drop = FALSE]
Xc <- GetAssayData(scRNA_astro, assay = assay_herv, slot = "counts")[panel, , drop = FALSE]
scRNA_astro$herv_expr_score <- Matrix::colMeans(Xd)
scRNA_astro$herv_detect_score <- Matrix::colMeans(Xc > 0)
# 在astro内把候选hERV家族分成up和down，分别计算分数
# 因为是根据astro的差异表达结果分的，所以只在astro内计算
up_set <- c("HARLEQUIN","HERVEA")
down_set <- c("HML1","HML3","HML4","HERVK14C","MER101","HERVH48","MER41","HERVW")
scRNA_astro$herv_up_expr <- Matrix::colMeans(Xd[up_set, , drop=FALSE])
scRNA_astro$herv_up_detect <- Matrix::colMeans(Xc[up_set, , drop=FALSE] > 0)
scRNA_astro$herv_down_expr <- Matrix::colMeans(Xd[down_set, , drop=FALSE])
scRNA_astro$herv_down_detect <- Matrix::colMeans(Xc[down_set, , drop=FALSE] > 0)
# 在Astro内按分位选出hERV-high/low
make_state <- function(x, q_lo = 0.2, q_hi = 0.8) {
  lo <- quantile(x, q_lo, na.rm = TRUE)
  hi <- quantile(x, q_hi, na.rm = TRUE)
  ifelse(x >= hi, "high", ifelse(x <= lo, "low", "mid"))
}
metaA <- scRNA_astro@meta.data
metaA$herv_state <- make_state(metaA$herv_detect_score)
# 看它是否富集在某些Astro子群
tab1 <- prop.table(table(metaA$herv_state, metaA[[astro_sub_col]]), 2)
# 看AD/NC是否富集
tab2 <- prop.table(table(metaA$herv_state, metaA$group), 2)
df_sample <- metaA %>%
  group_by(orig.ident, group) %>%
  summarise(frac_high = mean(herv_state=="high"),
            frac_low  = mean(herv_state=="low"),
            mean_det  = mean(herv_detect_score),
            .groups="drop")
wilcox.test(frac_high ~ group, data=df_sample)
wilcox.test(frac_low  ~ group, data=df_sample)
wilcox.test(mean_det  ~ group, data=df_sample)
```

```
> print(tab1)
               a1        a10        a11        a12
  high 0.16137194 0.52020202 0.50948509 0.03973510
  low  0.29828507 0.05808081 0.04607046 0.47019868
  mid  0.54034299 0.42171717 0.44444444 0.49006623
               a2         a3         a4         a5
  high 0.09337094 0.07827059 0.40797872 0.17536141
  low  0.39576869 0.37644428 0.12925532 0.24827153
  mid  0.51086037 0.54528513 0.46276596 0.57636706
               a6         a7         a8         a9
  high 0.30274510 0.41120000 0.08191489 0.36034115
  low  0.21176471 0.16080000 0.40212766 0.08528785
  mid  0.48549020 0.42800000 0.51595745 0.55437100
> print(tab2)
              NC        AD
  high 0.2675068 0.1502837
  low  0.2491975 0.3110882
  mid  0.4832957 0.5386282

data:  frac_high by group
W = 69, p-value = 0.31
data:  frac_low by group
W = 44, p-value = 0.5079
data:  mean_det by group
W = 68, p-value = 0.3451
```

**计算6大细胞类型和astro子群的hERV表达分数和检出率**

```r
meta <- seu@meta.data %>%
  mutate(cell = rownames(seu@meta.data)) %>%
  dplyr::select(cell, orig.ident, group, celltype,
         herv_expr_score, herv_detect_score)
# 6大细胞类型在样本层面计算均值
pb_celltype <- meta %>%
  group_by(orig.ident, group, celltype) %>%
  summarise(n_cells = n(),
            detect_frac = mean(herv_detect_score),
            mean_expr   = mean(herv_expr_score),
            .groups = "drop")
# 每个细胞类型里AD-NC
test_celltype <- pb_celltype %>%
  group_by(celltype) %>%
  summarise(p_detect = tryCatch(wilcox.test(detect_frac ~ group)$p.value, error=function(e) NA_real_),
            p_expr   = tryCatch(wilcox.test(mean_expr   ~ group)$p.value, error=function(e) NA_real_),
            .groups="drop")
# Astro子群
pb_astro_sub <- scRNA_astro@meta.data %>%
  group_by(group, .data[[astro_sub_col]]) %>%
  summarise(n_cells = n(),
            detect_frac = mean(herv_detect_score),
            mean_expr   = mean(herv_expr_score),
            .groups="drop")
```

![my_GSE157827_2_29](/upload/md-image/other/my_GSE157827_2_29.png){:width="300px" height="300px"}

![my_GSE157827_2_30](/upload/md-image/other/my_GSE157827_2_30.png){:width="500px" height="500px"}

- 在每个细胞类型中，如果按上面选出的这些hERV家族计算分数，AD和NC的分数差异仍不明显，说明选出的hERV家族的表达情况在各细胞类型中并不一致
- 结合tab1/2，在astro内部，不同亚群的检出率和表达量差异较大，说明这种方法计算得到的hERV分数更像是在刻画Astro内部的“hERV活跃度状态”，而不是纯AD效应
- astro各亚群的high/low比例显著不同，说明这个分数确实能“定义一类Astro状态”，但不能稳健地区分AD-NC（AD-NC差异主要来自子群比例改变）

**看我们的hERV分数定义的astro子群**

```r
# 看一下样本的平均分数分布（在astro的各亚群内）
pb <- metaA %>%
  group_by(orig.ident, group, sle_reso) %>%
  summarise(detect_frac = mean(herv_detect_score),
            mean_expr   = mean(herv_expr_score),
            n_cells = n(),
            .groups="drop")
sub_rank <- pb %>%
  group_by(sle_reso) %>%
  summarise(detect_frac = mean(detect_frac),
            mean_expr   = mean(mean_expr),
            .groups="drop") %>%
  arrange(desc(detect_frac))
ggplot(pb, aes(x = sle_reso, y = detect_frac, color = group)) +
  geom_point(position = position_jitter(width = 0.15), alpha = 0.7) +
  theme_classic() +
  labs(y="Panel detect fraction (per sample)", x="Astro subcluster")
```

![my_GSE157827_2_31](/upload/md-image/other/my_GSE157827_2_31.png){:width="500px" height="500px"}

在astro内的hERV-gene共表达
- 根据subrank的排名，选出HERV-high端（a11/a9/a7/a4）和HERV-low端（a3/a5/a8/a1）
- 看这两端在基因表达上的差别（FindMarkers）
- hERV-gene共表达：哪些基因和“hERV 状态轴”同步变化




### 关于上次的一些问题

重合的基因过少，差在哪里

多重比对的处理方法，多重比对是丢弃还是保留
