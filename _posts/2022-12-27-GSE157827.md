---
layout: mypost
title: GSE157827数据集练习
category: other
subcategory: other-other
---

2025.12.17-2025.12.31研究进展

<!-- more -->

### 跟着教程做复现

参考教程：[复现2：AD与Normal细胞类型水平的差异基因挖掘(snRNA-seq)](https://www.jianshu.com/p/d7e086020fc8)

#### 构建Seurat对象

**下载计数矩阵**

```sh
cd /public/home/GENE_proc/wth/GSE157827/raw_data/raw_mtx_gz/
wget https://ftp.ncbi.nlm.nih.gov/geo/series/GSE157nnn/GSE157827/suppl/GSE157827_RAW.tar
tar -xvf GSE157827_RAW.tar
rm GSE157827_RAW.tar
```

**使用`Read10X`直接构建Seurat对象**

```r
library(Seurat)
library(tidyverse)
root_dir <- '/public/home/GENE_proc/wth/GSE157827/raw_data/raw_mtx_gz/'
fs <- list.files(root_dir, '^GSM')
samples <- str_split(fs, '_', simplify = T)[, 1]
# 批量将文件名改为 Read10X()函数能够识别的名字
lapply(unique(samples), function(x){
    y <- fs[grepl(x, fs)]
    folder <- paste0(root_dir, paste(str_split(y[1], '_', simplify = T)[, 1:2], collapse = "_"))
    dir.create(folder,recursive = T)
    # 为每个样本创建子文件夹
    file.rename(paste0(root_dir, y[1]), file.path(folder, "barcodes.tsv.gz"))
    # 重命名文件，并移动到相应的子文件夹里
    file.rename(paste0(root_dir, y[2]), file.path(folder, "features.tsv.gz"))
    file.rename(paste0(root_dir, y[3]), file.path(folder, "matrix.mtx.gz"))
})
samples <- list.files(root_dir, '^GSM')
dir <- file.path(root_dir, samples)
names(dir) <- samples
# 创建Seurat对象
counts <- Read10X(data.dir = dir)
scRNA <- CreateSeuratObject(counts)
```

```
> dim(scRNA)  # 查看基因数和细胞总数
[1]  33538 179392
> table(scRNA@meta.data$orig.ident)  # 查看每个样本的细胞数
GSM4775561 GSM4775562 GSM4775563 GSM4775564 GSM4775565 GSM4775566 GSM4775567 
      6243      15357       6166      12362       2990       2654      10229 
GSM4775568 GSM4775569 GSM4775570 GSM4775571 GSM4775572 GSM4775573 GSM4775574 
     16156       1829       3794       9208       8472       6327       6483 
GSM4775575 GSM4775576 GSM4775577 GSM4775578 GSM4775579 GSM4775580 GSM4775581 
      3576      15692      10983       8416       6348      14491      11616 
> colnames(scRNA@meta.data)
[1] "orig.ident"   "nCount_RNA"   "nFeature_RNA"
```

**metadata细节整理**

- `metadata.xlsx`：GSM号到样本号（AD1/NC1这种）的映射

  ![跟着教程做复现_GSE157827_1](/upload/md-image/other/跟着教程做复现_GSE157827_1.png){:width="600px" height="600px"}

- `sample_info.xlsx`：每个样本的年龄性别等诊断信息

  ![跟着教程做复现_GSE157827_2](/upload/md-image/other/跟着教程做复现_GSE157827_2.png){:width="800px" height="800px"}

```r
library(readxl)
# 读入并整理两个xlsx
meta_map <- read_xlsx("/public/home/GENE_proc/wth/GSE157827/raw_data/metadata/metadata.xlsx")
names(meta_map) <- make.names(names(meta_map))
meta_map <- meta_map %>%
  transmute(
    GSM       = as.character(sample_id),
    sample_id = as.character(individuals),
    group     = as.character(diagnosis),
    tissue    = as.character(tissue)
  ) %>%
  distinct()
sample_info <- read_xlsx("/public/home/GENE_proc/wth/GSE157827/raw_data/metadata/sample_info.xlsx")
names(sample_info) <- make.names(names(sample_info))
sample_info <- sample_info %>%
  mutate(sample_id = as.character(sample_id)) %>%
  select(-any_of("diagnosis"))
# 从Seurat取出每个细胞对应的GSM，并做两次join
cell_meta <- scRNA@meta.data %>%
  rownames_to_column("cell") %>%
  mutate(GSM = as.character(orig.ident))
cell_meta2 <- cell_meta %>%
  left_join(meta_map,    by = "GSM") %>%
  left_join(sample_info, by = "sample_id")
# 检查是否有映射失败
n_unmapped <- sum(is.na(cell_meta2$sample_id))
n_unmapped
# 添加metadata
new_cols <- setdiff(names(cell_meta2), names(scRNA@meta.data))
meta_to_add <- cell_meta2 %>%
  select(cell, all_of(new_cols)) %>%
  column_to_rownames("cell")
scRNA <- AddMetaData(scRNA, metadata = meta_to_add)
# orig.ident用AD1/NC1，group用AD/NC，并设置排序
scRNA$orig.ident <- scRNA$sample_id
scRNA$group <- factor(scRNA$group, levels = c("NC", "AD"))
sample_levels <- unique(as.character(scRNA$orig.ident))
num_part <- as.numeric(str_extract(sample_levels, "\\d+"))
grp_part <- substr(sample_levels, 1, 2)
ord <- order(match(grp_part, c("NC", "AD")), num_part)
scRNA$orig.ident <- factor(scRNA$orig.ident, levels = sample_levels[ord])
```

**保存为rds对象**

```r
saveRDS(
    scRNA, 
    file = file.path("/public/home/GENE_proc/wth/GSE157827/data/", "GSE157827.rds"), 
    compress = "xz"
)
```

**抽取1/3到本地电脑作测试**

```r
set.seed(20251220)
prop_keep <- 1/3
cells_keep <- scRNA@meta.data %>%
  rownames_to_column("cell") %>%
  group_by(orig.ident) %>%
  slice_sample(prop = prop_keep) %>%
  pull(cell)
scRNA_smaller <- subset(scRNA, cells = cells_keep)
# 检查抽样结果
print(ncol(scRNA)); print(ncol(scRNA_smaller))  # 179392  59791
print(table(scRNA_smaller$group))
print(table(scRNA_smaller$orig.ident, scRNA_smaller$group))
# 保存
saveRDS(
    scRNA_smaller, 
    file = file.path("/public/home/GENE_proc/wth/GSE157827/data/", "GSE157827_smaller.rds"), 
    compress = "xz"
)
```

**看一看结果**

```r
scRNA <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\data\\GSE157827_smaller.rds")
# scRNA <- readRDS("/public/home/GENE_proc/wth/GSE157827/data/GSE157827.rds")
res_dir <- "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\res"
# res_dir <- "/public/home/GENE_proc/wth/GSE157827/教程复现/res/"
```

```
> scRNA
An object of class Seurat 
33538 features across 59791 samples within 1 assay 
Active assay: RNA (33538 features, 0 variable features)
 1 layer present: counts
```

![跟着教程做复现_GSE157827_3](/upload/md-image/other/跟着教程做复现_GSE157827_3.png){:width="800px" height="800px"}

#### 质控

```r
library(Seurat)
library(tidyverse)
library(patchwork)
library(ggVennDiagram)
library(Matrix)
library(ggbreak)
```

注：后续的结果输出/图片都是使用完整数据的

**过滤前的各项指标**

```r
# 基因数/UMI数
feats <- c("nFeature_RNA", "nCount_RNA")
p_filt_b_1 <- VlnPlot(
  scRNA, features = feats,
  pt.size = 0,
  ncol = 2,
  group.by = "group"  # 按AD/NC分组看分布
) + NoLegend()
p_filt_b_2 <- VlnPlot(
  scRNA, features = feats,
  pt.size = 0,
  ncol = 1,
  group.by = "orig.ident"  # 按样本(AD1/NC1...)看分布
) + NoLegend()
# 线粒体/核糖体比例
mito_genes <- rownames(scRNA)[grep("^MT-", rownames(scRNA))]  # 线粒体基因：通常以"MT-"开头
scRNA <- PercentageFeatureSet(scRNA, pattern = "^MT-", col.name = "percent_mito")  # 每个细胞中，线粒体基因UMI占比
ribo_genes <- rownames(scRNA)[grep("^Rp[sl]", rownames(scRNA), ignore.case = TRUE)]  # 核糖体基因：通常以RPL或RPS开头
scRNA <- PercentageFeatureSet(scRNA, pattern = "^RP[SL]", col.name = "percent_ribo")  # 每个细胞中，核糖体基因UMI占比
feats <- c("percent_mito", "percent_ribo")
p_filt_b_3 <- VlnPlot(
  scRNA, features = feats, 
  pt.size = 0, 
  ncol = 2,
  group.by = "group"  # 按AD/NC分组看分布
) + NoLegend()
p_filt_b_4 <- VlnPlot(
  scRNA, features = feats, 
  pt.size = 0, 
  ncol = 1,
  group.by = "orig.ident"  # 按样本看分布
) + NoLegend()
# 拼图展示
pdf(file.path(res_dir, "before_filter.pdf"))
p <- (p_filt_b_1 / p_filt_b_2) | (p_filt_b_3 / p_filt_b_4)
print(p)
dev.off()
```

```
> fivenum(scRNA@meta.data$percent_mito)
[1]  0.0000000  0.4171011  0.9939049  2.5860344 97.8759558
> fivenum(scRNA@meta.data$percent_ribo)
[1]  0.0000000  0.2645503  0.3795066  0.5625879 16.0344828
```

- 对应`min / Q1 / median / Q3 / max`这5个指标，快速了解分布范围，大概看一下阈值怎么取

![跟着教程做复现_GSE157827_4](/upload/md-image/other/跟着教程做复现_GSE157827_4.png){:width="800px" height="800px"}

- 和之前的教程比起来，他多了一个核糖体基因基因比例，这个指标也可能提示污染或技术噪声

**确定过滤阈值**

细胞阈值：

```r
# 设置阈值
retained_c_umi_low  <- scRNA$nFeature_RNA > 300
retained_c_umi_high <- scRNA$nFeature_RNA < 8000
retained_c_mito     <- scRNA$percent_mito < 14
retained_c_ribo     <- scRNA$percent_ribo < 3
keep_cells <- retained_c_mito & retained_c_ribo & retained_c_umi_low & retained_c_umi_high
# 用Venn图看看是哪个过滤条件剔除了细胞
umi_low  <- Cells(scRNA)[!retained_c_umi_low]
umi_high <- Cells(scRNA)[!retained_c_umi_high]
mito     <- Cells(scRNA)[!retained_c_mito]
ribo     <- Cells(scRNA)[!retained_c_ribo]
veen_eles <- list(
  `Filt_low_umi\n(300)`   = umi_low,
  `Filt_high_umi\n(8000)` = umi_high,
  `Filt_high_mito\n(14%)` = mito,
  `Filt_high_ribo\n(3%)`  = ribo
)
pdf(file.path(res_dir, "cell_filter.pdf"), width = 12, height = 8)
p <- ggVennDiagram(veen_eles, set_size = 4) +
  scale_fill_gradient(low = "#ffffb2", high = "#f03b20")
print(p)
dev.off()
```

```
> table(keep_cells)  # 看看最后保留/剔除多少细胞
keep_cells
 FALSE   TRUE 
  9876 169516 
> table(scRNA$group[keep_cells])  # 看看保留下来的细胞在AD/NC里各多少（检查过滤是否对某组特别“偏心”）
   NC    AD 
79036 90480 
```

![跟着教程做复现_GSE157827_5](/upload/md-image/other/跟着教程做复现_GSE157827_5.png){:width="800px" height="800px"}

- 如果`Filt_low_umi`单独占很大：说明很多细胞信息量太少
- 如果`Filt_high_mito/Filt_high_ribo`占很大（图中情况）：说明样本可能有较多“质量差/污染/应激”的核
- 大量重叠（比较常见）：表示同一批坏细胞同时表现出多种坏指标

基因阈值：按“在多少细胞里出现过”过滤基因，去掉极低频基因（例如只在极少数细胞里出现一次的噪声）
- 减少噪声，加快后续计算速度

```r
counts <- GetAssayData(scRNA, assay = "RNA", slot = "counts")
feature_rowsum <- Matrix::rowSums(counts > 0)  # 每个基因在多少个细胞里出现过
# 只保留“至少在0.5%细胞里表达过”的基因
retained_f_low <- feature_rowsum > ncol(scRNA) * 0.005
# rankplot辅助看阈值
rankplot <- data.frame(
  feature_count = sort(feature_rowsum),
  gene = names(sort(feature_rowsum)),
  Rank = 1:length(feature_rowsum)
)
pdf(file.path(res_dir, "gene_filter.pdf"), width = 12, height = 8)
p <- ggplot(rankplot, aes(x = Rank, y = feature_count)) +
  geom_point() +
  scale_y_break(c(10000, 100000)) +  # 断轴，避免极高表达基因把图压扁
  geom_hline(
    yintercept = ncol(scRNA) * 0.005, 
    color = "red"
  ) +
  geom_text(
    x = 10000, y = 4000, size = 5,
    label = "Feature cutoff : ncol(scRNA)*0.5%"
  )
print(p)
dev.off()
```

```
> table(retained_f_low)
retained_f_low
FALSE  TRUE 
16262 17276 
```

![跟着教程做复现_GSE157827_6](/upload/md-image/other/跟着教程做复现_GSE157827_6.png){:width="800px" height="800px"}

- 红线就是阈值（在多少个细胞里表达过）
- 红线以下的点 = 低频基因（被过滤掉）
- 只要确认红线切的位置“在低频尾巴”而不是切到主体即可

**过滤**

```r
scRNA_filt <- scRNA[retained_f_low, keep_cells]
# 过滤后的各项指标
feats <- c("nFeature_RNA", "nCount_RNA")
p_filt_a_1 <- VlnPlot(
  scRNA_filt, features = feats, 
  pt.size = 0, ncol = 2,
  group.by = "group"
) + NoLegend()
p_filt_a_2 <- VlnPlot(
  scRNA_filt, features = feats, 
  pt.size = 0, ncol = 1,
  group.by = "orig.ident"
) + NoLegend()
feats <- c("percent_mito", "percent_ribo")
p_filt_a_3 <- VlnPlot(
  scRNA_filt, features = feats, 
  pt.size = 0, ncol = 2,
  group.by = "group"
) + NoLegend()
p_filt_a_4 <- VlnPlot(
  scRNA_filt, features = feats, 
  pt.size = 0, ncol = 1,
  group.by = "orig.ident"
) + NoLegend()
pdf(file.path(res_dir, "after_filter.pdf"))
p <- (p_filt_a_1 / p_filt_a_2) | (p_filt_a_3 / p_filt_a_4)
print(p)
dev.off()
```

```
> dim(scRNA_filt)  # 过滤后的基因数x细胞数
[1]  17276 169516
> table(scRNA_filt$group)  # 过滤后AD/NC细胞数
   NC    AD 
79036 90480 
```

![跟着教程做复现_GSE157827_8](/upload/md-image/other/跟着教程做复现_GSE157827_8.png){:width="800px" height="800px"}

- `dim(scRNA_filt)`：细胞数会下降、基因数也会下降
- `nFeature_RNA`的下尾被“抬高”（低质量细胞被清掉）
- `percent_mito/percent_ribo`的高尾被砍掉（异常核比例下降）

```r
# 保存过滤后的对象
saveRDS(
    scRNA_filt, 
    file = file.path("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\data", "GSE157827_smaller_filt.rds"), 
    compress = "xz"
)
# saveRDS(
#     scRNA_filt, 
#     file = file.path("/public/home/GENE_proc/wth/GSE157827/data/", "GSE157827_filt.rds"), 
#     compress = "xz"
# )
```

#### 数据预处理

```r
library(Seurat)
library(tidyverse)
library(patchwork)
library(clustree)
# library(future)
# # future设置（如果后续报错可以不执行这段）
# plan("multisession", workers = 4)
# options(future.globals.maxSize = 20000 * 1024^2)
```

```r
scRNA <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\data\\GSE157827_smaller_filt.rds")
# scRNA <- readRDS("/public/home/GENE_proc/wth/GSE157827/data/GSE157827_filt.rds")
res_dir <- "C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\res"
# res_dir <- "/public/home/GENE_proc/wth/GSE157827/教程复现/res/"
```

由于数据量比较大，`ScaleData`函数比较耗时，尤其是加上回归参数。可使用`future`包的`plan`函数设置线程数
- 推荐使用四个线程，此外如果在`FindIntegrationAnchors`步骤使用报错，设置`options(future.globals.maxSize = 1000 * 1024^2)`即可

```r
# NormalizeData
scRNA <- NormalizeData(
  scRNA,
  normalization.method = "LogNormalize",
  scale.factor = 10000
)
# FindVariableFeatures
scRNA <- FindVariableFeatures(
  scRNA,
  selection.method = "vst",
  nfeatures = 2000
)
# ScaleData
scRNA <- ScaleData(
  scRNA,
  features = VariableFeatures(scRNA),
  vars.to.regress = c("nFeature_RNA", "percent_mito")    # 根据教程，回归了nFeature_RNA和percent_mito
)
# PCA
scRNA <- RunPCA(scRNA, features = VariableFeatures(scRNA))
# 选PC数量：ElbowPlot
pdf(file.path(res_dir, "ElbowPlot_all.pdf"))
p <- ElbowPlot(scRNA, ndims = 50, reduction = "pca")
print(p)
dev.off()
```

![跟着教程做复现_GSE157827_7](/upload/md-image/other/跟着教程做复现_GSE157827_7.png){:width="800px" height="800px"}

- 横轴PC序号，纵轴是每个PC解释的方差强度，可以看到：
  - 前~10个PC下降很陡
  - 到~15-20左右开始明显变平
  - 20之后的增益更小
- 因为教程后面在具体细胞类型用的是`pc.num = 1:30`，所以这里就也沿用了（教程这里没给用的是多少）。只是更“保守/宽松”，可能把一点噪声也带进邻接图里
  如果后面注释发现细胞类型分的过宽泛（很多大类细胞被混成一类），就提高PC/resolution；如果碎成很多小簇、marker不清晰，就降低PC（如1:20）或resolution；如果主要大簇结构和marker注释结论一致，就不用更改

```r
pc.num <- 1:30
# UMAP
scRNA <- RunUMAP(scRNA, dims = pc.num)
# 按AD/NC上色看看整体是否有明显批次/分组分离
p_dim_group <- DimPlot(scRNA, group.by = "group")
# FindNeighbors
scRNA <- FindNeighbors(scRNA, dims = pc.num)
# FindClusters：一次跑多个resolution，方便对比分群“粗/细”
scRNA <- FindClusters(scRNA, resolution = c(0.01, 0.05, 0.1, 0.2, 0.5))
# clustree：看不同resolution之间的聚类“分裂关系”
p_cutree <- clustree(scRNA@meta.data, prefix = "RNA_snn_res.")
# 选一个resolution作为最终cluster标签（教程选0.05）
Idents(scRNA) <- scRNA$RNA_snn_res.0.05
table(Idents(scRNA))
# 把cluster编号标到UMAP上
p_dim_cluster <- DimPlot(scRNA, label = TRUE)
# 拼图展示
pdf(file.path(res_dir, "data_preprocess.pdf"), width = 16, height = 8)
p <- p_dim_group | p_cutree | p_dim_cluster
print(p)
dev.off()
```

![跟着教程做复现_GSE157827_9](/upload/md-image/other/跟着教程做复现_GSE157827_9.png){:width="800px" height="800px"}

- `DimPlot`：AD/NC是否混在一起
  正常情况下，同一细胞类型的AD/NC往往会混在一起（因为细胞类型差异通常比疾病状态更强），如果发现AD和NC几乎完全分成两堆，更常见原因是批次效应/样本差异（例如不同样本测序深度、细胞比例差异等），后面可以再讨论是否要做整合或回归更多变量
- `clustree`：选resolution，resolution越大，cluster越多越细
  方法：随着分辨率增大，cluster是不是稳定、是不是“过度碎裂”（出现很多只有几十/几百细胞的小簇）、marker是否清晰（每类marker是否集中在少数几个簇上，如果某个簇同时高表达两类互斥marker，就说明分辨率太低）
  - 每一行对应一个分辨率，每个圆点(node)是该分辨率下的一个cluster，圆越大表示细胞越多；连线(edge)表示“上一分辨率的某个簇”在下一分辨率里主要分成了哪些簇；线越粗/越直观代表继承关系越明确、越稳定（基本可理解为“绝大多数细胞都流向同一个子簇”）
  - 0.01往往只给你很少的几个大簇，容易把不同细胞类型混在同一簇里，后面做marker注释会比较费劲
  - 0.05这一层通常能把数据拆成十来个左右的簇，并且从0.01到0.05的分裂关系比较清楚：大簇分裂成几个仍然比较大的子簇，而不是碎成很多小点。符合“**先用一个较粗但能分开大类的分辨率完成主图/主注释**”的目标
  - 0.1/0.2/0.5更细，但容易“过度分裂”，同一大类细胞会被继续拆成很多子簇，不适合直接做大类注释。可以**先用0.05做大类注释，再对某个大类subset后重新聚类，并把resolution提高来做亚群分析**
- `table(Idents(scRNA))`：每个cluster大小
  如果出现极小cluster（比如只有几十个细胞），后面注释时要小心：可能是稀有细胞，也可能是噪声残留

这里发现我使用完整数据的聚类结果竟然有13个簇，反而抽样数据的聚类结果和作者的很类似（只有12个簇），不过似乎UMAP结果不一样是正常的，因为它本身就是随机/近似算法（没设随机种子时，形状、旋转、间距都会变），这些差异通常只影响“图长什么样”，不一定影响生物学结论，但后面细胞类型注释时就需要自己分析一下，不能直接照抄作者的对应关系

#### 细胞类型注释

```r
library(Seurat)
library(tidyverse)
library(patchwork)
```

scRNA <- readRDS("/public/home/GENE_proc/wth/GSE157827/data/GSE157827_1221.rds")


