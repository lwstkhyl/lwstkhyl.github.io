---
layout: mypost
title: GSE157827数据集练习
category: other
subcategory: other-other
---

2025.12.17-2025.12.31研究进展

<!-- more -->

### 跟着教程做复现

#### 构建Seurat对象

**下载计数矩阵**

```sh
cd /public/home/GENE_proc/wth/GSE157827/raw_data/raw_mtx_gz/
wget https://ftp.ncbi.nlm.nih.gov/geo/series/GSE157nnn/GSE157827/suppl/GSE157827_RAW.tar
tar -xvf GSE157827_RAW.tar
rm GSE157827_RAW.tar
```

**使用`Read10X`直接构建Seurat对象**

```r
library(Seurat)
library(tidyverse)
root_dir <- '/public/home/GENE_proc/wth/GSE157827/raw_data/raw_mtx_gz/'
fs <- list.files(root_dir, '^GSM')
samples <- str_split(fs, '_', simplify = T)[, 1]
# 批量将文件名改为 Read10X()函数能够识别的名字
lapply(unique(samples), function(x){
    y <- fs[grepl(x, fs)]
    folder <- paste0(root_dir, paste(str_split(y[1], '_', simplify = T)[, 1:2], collapse = "_"))
    dir.create(folder,recursive = T)
    # 为每个样本创建子文件夹
    file.rename(paste0(root_dir, y[1]), file.path(folder, "barcodes.tsv.gz"))
    # 重命名文件，并移动到相应的子文件夹里
    file.rename(paste0(root_dir, y[2]), file.path(folder, "features.tsv.gz"))
    file.rename(paste0(root_dir, y[3]), file.path(folder, "matrix.mtx.gz"))
})
samples <- list.files(root_dir, '^GSM')
dir <- file.path(root_dir, samples)
names(dir) <- samples
# 创建Seurat对象
counts <- Read10X(data.dir = dir)
scRNA <- CreateSeuratObject(counts)
```

```
> dim(scRNA)  # 查看基因数和细胞总数
[1]  33538 179392
> table(scRNA@meta.data$orig.ident)  # 查看每个样本的细胞数
GSM4775561 GSM4775562 GSM4775563 GSM4775564 GSM4775565 GSM4775566 GSM4775567 
      6243      15357       6166      12362       2990       2654      10229 
GSM4775568 GSM4775569 GSM4775570 GSM4775571 GSM4775572 GSM4775573 GSM4775574 
     16156       1829       3794       9208       8472       6327       6483 
GSM4775575 GSM4775576 GSM4775577 GSM4775578 GSM4775579 GSM4775580 GSM4775581 
      3576      15692      10983       8416       6348      14491      11616 
> colnames(scRNA@meta.data)
[1] "orig.ident"   "nCount_RNA"   "nFeature_RNA"
```

**metadata细节整理**

- `metadata.xlsx`：GSM号到样本号（AD1/NC1这种）的映射

  ![跟着教程做复现_GSE157827_1](/upload/md-image/other/跟着教程做复现_GSE157827_1.png){:width="600px" height="600px"}

- `sample_info.xlsx`：每个样本的年龄性别等诊断信息

  ![跟着教程做复现_GSE157827_2](/upload/md-image/other/跟着教程做复现_GSE157827_2.png){:width="800px" height="800px"}

```r
library(readxl)
# 读入并整理两个xlsx
meta_map <- read_xlsx("/public/home/GENE_proc/wth/GSE157827/raw_data/metadata/metadata.xlsx")
names(meta_map) <- make.names(names(meta_map))
meta_map <- meta_map %>%
  transmute(
    GSM       = as.character(sample_id),
    sample_id = as.character(individuals),
    group     = as.character(diagnosis),
    tissue    = as.character(tissue)
  ) %>%
  distinct()
sample_info <- read_xlsx("/public/home/GENE_proc/wth/GSE157827/raw_data/metadata/sample_info.xlsx")
names(sample_info) <- make.names(names(sample_info))
sample_info <- sample_info %>%
  mutate(sample_id = as.character(sample_id)) %>%
  select(-any_of("diagnosis"))
# 从Seurat取出每个细胞对应的GSM，并做两次join
cell_meta <- scRNA@meta.data %>%
  rownames_to_column("cell") %>%
  mutate(GSM = as.character(orig.ident))
cell_meta2 <- cell_meta %>%
  left_join(meta_map,    by = "GSM") %>%
  left_join(sample_info, by = "sample_id")
# 检查是否有映射失败
n_unmapped <- sum(is.na(cell_meta2$sample_id))
n_unmapped
# 添加metadata
new_cols <- setdiff(names(cell_meta2), names(scRNA@meta.data))
meta_to_add <- cell_meta2 %>%
  select(cell, all_of(new_cols)) %>%
  column_to_rownames("cell")
scRNA <- AddMetaData(scRNA, metadata = meta_to_add)
# orig.ident用AD1/NC1，group用AD/NC，并设置排序
scRNA$orig.ident <- scRNA$sample_id
scRNA$group <- factor(scRNA$group, levels = c("NC", "AD"))
sample_levels <- unique(as.character(scRNA$orig.ident))
num_part <- as.numeric(str_extract(sample_levels, "\\d+"))
grp_part <- substr(sample_levels, 1, 2)
ord <- order(match(grp_part, c("NC", "AD")), num_part)
scRNA$orig.ident <- factor(scRNA$orig.ident, levels = sample_levels[ord])
```

**保存为rds对象**

```r
saveRDS(
    scRNA, 
    file = file.path("/public/home/GENE_proc/wth/GSE157827/data/", "GSE157827.rds"), 
    compress = "xz"
)
```

**抽取1/3到本地电脑作测试**

```r
set.seed(20251220)
prop_keep <- 1/3
cells_keep <- scRNA@meta.data %>%
  rownames_to_column("cell") %>%
  group_by(orig.ident) %>%
  slice_sample(prop = prop_keep) %>%
  pull(cell)
scRNA_smaller <- subset(scRNA, cells = cells_keep)
# 检查抽样结果
print(ncol(scRNA)); print(ncol(scRNA_smaller))  # 179392  59791
print(table(scRNA_smaller$group))
print(table(scRNA_smaller$orig.ident, scRNA_smaller$group))
# 保存
saveRDS(
    scRNA_smaller, 
    file = file.path("/public/home/GENE_proc/wth/GSE157827/data/", "GSE157827_smaller.rds"), 
    compress = "xz"
)
```

**看一看结果**

```r
library(Seurat)
library(tidyverse)
scRNA <- readRDS("C:\\Users\\17185\\Desktop\\hERV_calc\\GSE157827\\data\\GSE157827_smaller.rds")
# scRNA <- readRDS("/public/home/GENE_proc/wth/GSE157827/data/GSE157827.rds")
```

```
> scRNA
An object of class Seurat 
33538 features across 59791 samples within 1 assay 
Active assay: RNA (33538 features, 0 variable features)
 1 layer present: counts
```

![跟着教程做复现_GSE157827_3](/upload/md-image/other/跟着教程做复现_GSE157827_3.png){:width="800px" height="800px"}

